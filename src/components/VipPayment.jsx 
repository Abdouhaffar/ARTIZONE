import React, { useState } from "react";
import { db, storage, auth } from "../firebaseConfig";
import { addDoc, collection, serverTimestamp } from "firebase/firestore";
import { ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { useNavigate } from "react-router-dom";

export default function VipPayment() {
  const nav = useNavigate();
  const [plan, setPlan] = useState("1m");
  const [file, setFile] = useState(null);
  const [msg, setMsg] = useState("");
  const [loading, setLoading] = useState(false);

  const prices = {
    "1m": 300,
    "6m": 1500,
    "12m": 2500,
  };

  const submit = async (e) => {
    e.preventDefault();
    if (!auth.currentUser) return setMsg("❌ يجب تسجيل الدخول أولاً");

    setLoading(true);

    try {
      let url = "";

      if (file) {
        const r = ref(storage, `vipProofs/${auth.currentUser.uid}/${file.name}`);
        await uploadBytes(r, file);
        url = await getDownloadURL(r);
      }

      await addDoc(collection(db, "vipRequests"), {
        uid: auth.currentUser.uid,
        plan,
        price: prices[plan],
        proofUrl: url,
        status: "pending",
        createdAt: serverTimestamp(),
      });

      setMsg("✔ تم إرسال طلبك، سيتم مراجعته قريباً.");
      setTimeout(() => nav("/"), 1500);
    } catch (err) {
      setMsg("❌ حدث خطأ.");
    }

    setLoading(false);
  };

  return (
    <div className="page">
      <h2>الدفع للترقية</h2>

      <form onSubmit={submit}>
        <label>اختر الخطة:</label>
        <select value={plan} onChange={(e) => setPlan(e.target.value)}>
          <option value="1m">شهر — 300 دج</option>
          <option value="6m">6 أشهر — 1500 دج</option>
          <option value="12m">سنة — 2500 دج</option>
        </select>

        <label>رفع وصل الدفع:</label>
        <input
          type="file"
          accept="image/*,.pdf"
          onChange={(e) => setFile(e.target.files[0])}
        />

        <button disabled={loading}>
          {loading ? "جاري الرفع..." : "إرسال الطلب"}
        </button>
      </form>

      {msg && <p>{msg}</p>}
    </div>
  );
}